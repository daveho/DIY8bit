Further cleanup and modularization: specifically, make the command-reading
state machine into a separate module.
